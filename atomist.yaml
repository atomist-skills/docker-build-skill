#
#  Copyright Â© 2020 Atomist, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
 
skill:
  name: '@atomist/docker-build-skill'
  title: Docker Build and Push
  version: 0.1.0
  author: Atomist
  description: Build and push Docker images as a goal
  category:
    - ci
  technology:
    - docker
  license: Apache-2.0
  homepage: https://github.com/atomisthq/docker-item
  repository: https://github.com/atomisthq/docker-item.git
  icon: https://www.docker.com/sites/default/files/social/docker_facebook_share.png

  package:
    - use: '@atomist/package-sdm-skill/package'

goals:
  - name: build
    containers:
      - name: kaniko
        image: gcr.io/kaniko-project/executor
        args:
          - --context=dir:///atm/home
          - --destination=${parameters.image}:${parameters.tag:${push.after.version:${push.after.sha}}}
          - --dockerfile=${parameters.dockerfile:Dockerfile}
          - --cache=true
          - --cache-repo=${parameters.image}-cache
          - --force
        secrets:
          file_mounts:
            - mount_path: /kaniko/.docker/config.json
              value:
                provider:
                  type: docker
        resources:
          limits:
            cpu: 1000m
            memory: 2048Mi
          requests:
            cpu: 100m
            memory: 1024Mi
        security_context:
          run_as_group: 0
          run_as_non_root: false
          run_as_user: 0
    retry: true
