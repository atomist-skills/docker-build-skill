#
#  Copyright Â© 2020 Atomist, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
 
skill:
  name: atomist/docker-build-skill
  title: Docker Build and Push Skill
  version: 0.2.0
  author: Atomist
  description: Atomist Skill to build and push Docker images
  category:
    - ci
  technology:
    - docker
  license: Apache-2.0
  homepage: https://github.com/atomist-skills/docker-build-skill
  repository: https://github.com/atomist-skills/docker-build-skill.git
  icon: https://www.docker.com/sites/default/files/social/docker_facebook_share.png

  package:
    - use: atomist/package-sdm-skill/package

parameters:
  - string:
      name: registry
      display_name: Docker Image Registry
      description: Name/Url of the Docker Image Registry (defaults to repository owner)
      required: false
  - string:
      name: tag
      display_name: Docker Image Tag
      description: Tag to use when pushing the Docker image (defaults to snapshot version or sha)
      required: false

rules:

  - name: docker build
    tests:
      - is_output:
          type: build
          test:
            has_file: Dockerfile
    goals:
      - name: docker build
        containers:
          - name: kaniko
            image: gcr.io/kaniko-project/executor
            args:
              - --context=dir:///atm/home
              - --destination=${skill.configuration.parameters.registry:${repo.owner}}/${repo.name}:${skill.configuration.parameters.tag:${push.after.version:${push.after.sha}}}
              - --dockerfile=Dockerfile
              - --cache=true
              - --cache-repo=${skill.configuration.parameters.registry:${repo.owner}}/${repo.name}-cache
              - --force
            secrets:
              file_mounts:
                - mount_path: /kaniko/.docker/config.json
                  value:
                    provider:
                      type: docker
            resources:
              limits:
                cpu: 1000m
                memory: 2048Mi
              requests:
                cpu: 100m
                memory: 1024Mi
            security_context:
              run_as_group: 0
              run_as_non_root: false
              run_as_user: 0
        retry: true
